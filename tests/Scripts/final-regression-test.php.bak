<?php
/**
 * Final Business Hours Regression Test
 * 
 * Comprehensive test to validate the complete Business Hours feature migration
 * to structured BusinessHoursAction objects.
 */

echo "=== FINAL BUSINESS HOURS REGRESSION TEST ===\n\n";

function testResult($testName, $passed, $details = '') {
    $status = $passed ? '‚úÖ PASS' : '‚ùå FAIL';
    echo "$status $testName\n";
    if ($details) {
        echo "   $details\n";
    }
    echo "\n";
    return $passed;
}

$allTestsPassed = true;

// 1. Test Backend Structure
echo "1. BACKEND STRUCTURE TESTS\n";
echo "==========================\n\n";

$enumContent = file_get_contents('app/Enums/BusinessHoursActionType.php');
$allTestsPassed &= testResult(
    'BusinessHoursActionType enum exists',
    strpos($enumContent, 'enum BusinessHoursActionType') !== false
);

$allTestsPassed &= testResult(
    'BusinessHoursActionType has all required cases',
    strpos($enumContent, "case EXTENSION = 'extension'") !== false &&
    strpos($enumContent, "case RING_GROUP = 'ring_group'") !== false &&
    strpos($enumContent, "case IVR_MENU = 'ivr_menu'") !== false
);

$modelContent = file_get_contents('app/Models/BusinessHoursSchedule.php');
$allTestsPassed &= testResult(
    'Model has correct casts for structured actions',
    strpos($modelContent, "'open_hours_action' => 'json'") !== false &&
    strpos($modelContent, "'closed_hours_action' => 'json'") !== false &&
    strpos($modelContent, 'open_hours_action_type') !== false &&
    strpos($modelContent, 'closed_hours_action_type') !== false
);

$resourceContent = file_get_contents('app/Http/Resources/BusinessHoursScheduleResource.php');
$allTestsPassed &= testResult(
    'API resource returns structured actions',
    strpos($resourceContent, "'type' => .*getOpenHoursActionType()->value") !== false &&
    strpos($resourceContent, "'target_id' => .*getOpenHoursTargetId()") !== false
);

$validationContent = file_get_contents('app/Http/Requests/BusinessHours/StoreBusinessHoursScheduleRequest.php');
$allTestsPassed &= testResult(
    'Validation requires structured action format',
    strpos($validationContent, "'open_hours_action.type'") !== false &&
    strpos($validationContent, "'open_hours_action.target_id'") !== false
);

$controllerContent = file_get_contents('app/Http/Controllers/Api/BusinessHoursController.php');
$allTestsPassed &= testResult(
    'Controller has transformation methods',
    strpos($controllerContent, 'transformActionDataForStorage') !== false &&
    strpos($controllerContent, 'transformActionForResponse') !== false
);

// 2. Test Frontend Structure
echo "2. FRONTEND STRUCTURE TESTS\n";
echo "===========================\n\n";

$typesContent = file_get_contents('resources/js/types/business-hours.ts');
$hasStructuredInterface = strpos($typesContent, 'interface BusinessHoursAction {') !== false;
$hasStructuredType = strpos($typesContent, "type: 'extension' | 'ring_group' | 'ivr_menu'") !== false;
$hasStructuredRequest = strpos($typesContent, 'open_hours_action: BusinessHoursAction') !== false;

$allTestsPassed &= testResult(
    'Frontend types use structured BusinessHoursAction',
    $hasStructuredInterface && $hasStructuredType && $hasStructuredRequest,
    'BusinessHoursAction interface, type union, and request interfaces updated'
);

$formContent = file_get_contents('resources/js/components/BusinessHoursForm.tsx');
$hasActionSchema = strpos($formContent, 'const actionSchema = z.object({') !== false;
$hasStructuredValidation = strpos($formContent, "open_hours_action: actionSchema") !== false;

$allTestsPassed &= testResult(
    'Form component uses structured validation',
    $hasActionSchema && $hasStructuredValidation,
    'Zod schema updated to use actionSchema for actions'
);

// 3. Test Component Creation
echo "3. COMPONENT CREATION TESTS\n";
echo "===========================\n\n";

$actionSelectorExists = file_exists('resources/js/components/BusinessHours/ActionTypeSelector.tsx');
$targetSelectorExists = file_exists('resources/js/components/BusinessHours/TargetSelector.tsx');

$allTestsPassed &= testResult(
    'ActionTypeSelector component exists',
    $actionSelectorExists
);

$allTestsPassed &= testResult(
    'TargetSelector component exists',
    $targetSelectorExists
);

if ($actionSelectorExists) {
    $actionSelectorContent = file_get_contents('resources/js/components/BusinessHours/ActionTypeSelector.tsx');
    $hasTypeScriptInterface = strpos($actionSelectorContent, 'BusinessHoursActionType') !== false;
    $allTestsPassed &= testResult(
        'ActionTypeSelector uses correct TypeScript types',
        $hasTypeScriptInterface
    );
}

if ($targetSelectorExists) {
    $targetSelectorContent = file_get_contents('resources/js/components/BusinessHours/TargetSelector.tsx');
    $hasDynamicOptions = strpos($targetSelectorContent, 'switch (actionType)') !== false;
    $allTestsPassed &= testResult(
        'TargetSelector has dynamic options based on action type',
        $hasDynamicOptions
    );
}

// 4. Test Integration
echo "4. INTEGRATION TESTS\n";
echo "====================\n\n";

$formUsesSelectors = strpos($formContent, 'ActionTypeSelector') !== false && strpos($formContent, 'TargetSelector') !== false;
$allTestsPassed &= testResult(
    'Form integrates with new selector components',
    $formUsesSelectors
);

// 5. Test Backward Compatibility
echo "5. BACKWARD COMPATIBILITY TESTS\n";
echo "===============================\n\n";

$hasBackwardCompat = strpos($controllerContent, 'TODO: Remove this backward compatibility') !== false;
$allTestsPassed &= testResult(
    'Backward compatibility code is marked for removal',
    $hasBackwardCompat,
    'Controller has TODO comment for backward compatibility removal'
);

// 6. Final Summary
echo "6. FINAL TEST SUMMARY\n";
echo "=====================\n\n";

if ($allTestsPassed) {
    echo "üéâ ALL TESTS PASSED!\n\n";
    echo "The Business Hours feature has been successfully migrated to use structured BusinessHoursAction objects.\n\n";
    echo "‚úÖ Backend: Fully migrated to structured format\n";
    echo "‚úÖ Frontend: Types and components updated\n";
    echo "‚úÖ Validation: Requires structured format\n";
    echo "‚úÖ UI: New selector components created\n";
    echo "‚úÖ Integration: Form uses structured actions\n\n";
    
    echo "NEXT STEPS:\n";
    echo "1. Test the UI components in the browser\n";
    echo "2. Run end-to-end tests with real API calls\n";
    echo "3. Remove backward compatibility code after confirming everything works\n";
    echo "4. Update any documentation\n\n";
} else {
    echo "‚ùå SOME TESTS FAILED\n\n";
    echo "Please review the failed tests above and fix the issues before proceeding.\n\n";
}

echo "REGRESSION TEST COMPLETE\n";
