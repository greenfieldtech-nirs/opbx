openapi: 3.0.3
info:
  title: OPBX Users Management API
  description: |
    User management endpoints for creating, reading, updating, and deleting users.
    Includes role-based access control and organization scoping.
  version: 1.0.0
  contact:
    name: OPBX Development Team

servers:
  - url: http://localhost/api/v1
    description: Local development server
  - url: https://api.opbx.cloudonix.com/api/v1
    description: Production server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Laravel Sanctum Bearer token authentication

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          description: Unique user identifier
          example: 1
        organization_id:
          type: integer
          description: Organization this user belongs to
          example: 1
        name:
          type: string
          description: User's full name
          example: "John Doe"
        email:
          type: string
          format: email
          description: User's email address
          example: "john@example.com"
        role:
          type: string
          enum: [owner, admin, agent, reporter]
          description: User's role in the organization
          example: "admin"
        email_verified_at:
          type: string
          format: date-time
          nullable: true
          description: When the user's email was verified
          example: "2025-01-01T00:00:00.000000Z"
        created_at:
          type: string
          format: date-time
          description: When the user was created
          example: "2025-01-01T00:00:00.000000Z"
        updated_at:
          type: string
          format: date-time
          description: When the user was last updated
          example: "2025-01-01T00:00:00.000000Z"

    UserCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/User'
        links:
          type: object
          properties:
            first:
              type: string
              example: "http://localhost/api/v1/users?page=1"
            last:
              type: string
              example: "http://localhost/api/v1/users?page=5"
            prev:
              type: string
              nullable: true
              example: null
            next:
              type: string
              nullable: true
              example: "http://localhost/api/v1/users?page=2"
        meta:
          type: object
          properties:
            current_page:
              type: integer
              example: 1
            from:
              type: integer
              example: 1
            last_page:
              type: integer
              example: 5
            links:
              type: array
              items:
                type: object
                properties:
                  url:
                    type: string
                    nullable: true
                  label:
                    type: string
                  active:
                    type: boolean
            path:
              type: string
              example: "http://localhost/api/v1/users"
            per_page:
              type: integer
              example: 15
            to:
              type: integer
              example: 15
            total:
              type: integer
              example: 75

    CreateUserRequest:
      type: object
      required:
        - name
        - email
        - password
        - role
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: User's full name
          example: "John Doe"
        email:
          type: string
          format: email
          description: User's email address (must be unique)
          example: "john@example.com"
        password:
          type: string
          format: password
          minLength: 8
          description: User's password
          example: "securePassword123!"
        role:
          type: string
          enum: [owner, admin, agent, reporter]
          description: User's role in the organization
          example: "agent"
        password_reset_required:
          type: boolean
          description: Whether user must change password on first login
          default: false
          example: true

    UpdateUserRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: User's full name
          example: "John Smith"
        email:
          type: string
          format: email
          description: User's email address (must be unique)
          example: "john.smith@example.com"
        role:
          type: string
          enum: [owner, admin, agent, reporter]
          description: User's role in the organization
          example: "admin"
        password_reset_required:
          type: boolean
          description: Whether user must change password on next login
          example: false

    Error:
      type: object
      properties:
        message:
          type: string
          description: Error message
        errors:
          type: object
          description: Detailed validation errors

    ValidationError:
      type: object
      properties:
        message:
          type: string
          description: Error message
        errors:
          type: object
          description: Field-specific validation errors
          example:
            email: ["The email has already been taken."]
            password: ["The password must be at least 8 characters."]

  parameters:
    UserId:
      name: user
      in: path
      required: true
      schema:
        type: integer
      description: Unique user identifier
      example: 1

    Page:
      name: page
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        default: 1
      description: Page number for pagination
      example: 1

    PerPage:
      name: per_page
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 15
      description: Number of items per page
      example: 15

paths:
  /users:
    get:
      summary: List users
      description: |
        Retrieve a paginated list of users in the organization.

        Only users from the authenticated user's organization are returned.
        Results are ordered by creation date (newest first).
      operationId: listUsers
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PerPage'
      responses:
        '200':
          description: Users retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserCollection'
              example:
                data:
                  - id: 1
                    organization_id: 1
                    name: "Admin User"
                    email: "admin@example.com"
                    role: "owner"
                    email_verified_at: "2025-01-01T00:00:00.000000Z"
                    created_at: "2025-01-01T00:00:00.000000Z"
                    updated_at: "2025-01-01T00:00:00.000000Z"
                  - id: 2
                    organization_id: 1
                    name: "John Doe"
                    email: "john@example.com"
                    role: "admin"
                    email_verified_at: "2025-01-02T00:00:00.000000Z"
                    created_at: "2025-01-02T00:00:00.000000Z"
                    updated_at: "2025-01-02T00:00:00.000000Z"
                links:
                  first: "http://localhost/api/v1/users?page=1"
                  last: "http://localhost/api/v1/users?page=1"
                  prev: null
                  next: null
                meta:
                  current_page: 1
                  from: 1
                  last_page: 1
                  links:
                    - url: null
                      label: "&laquo; Previous"
                      active: false
                    - url: "http://localhost/api/v1/users?page=1"
                      label: "1"
                      active: true
                    - url: null
                      label: "Next &raquo;"
                      active: false
                  path: "http://localhost/api/v1/users"
                  per_page: 15
                  to: 2
                  total: 2

        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Create user
      description: |
        Create a new user in the organization.

        Requires admin-level permissions or higher.
        The new user will be automatically associated with the current organization.
      operationId: createUser
      tags:
        - Users
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
            example:
              name: "Jane Smith"
              email: "jane@example.com"
              password: "securePassword123!"
              role: "agent"
              password_reset_required: true
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  message:
                    type: string
                    example: "User created successfully"
              example:
                user:
                  id: 3
                  organization_id: 1
                  name: "Jane Smith"
                  email: "jane@example.com"
                  role: "agent"
                  email_verified_at: null
                  created_at: "2025-01-03T00:00:00.000000Z"
                  updated_at: "2025-01-03T00:00:00.000000Z"
                message: "User created successfully"

        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /users/{user}:
    get:
      summary: Get user details
      description: |
        Retrieve detailed information about a specific user.

        Users can only view users from their own organization.
      operationId: getUser
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: User details retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'

        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '403':
          description: Forbidden - user not in your organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: Update user
      description: |
        Update an existing user's information.

        Users can only update users from their own organization.
        Requires appropriate permissions based on roles.
      operationId: updateUser
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UserId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
            example:
              name: "Jane Smith"
              email: "jane.smith@example.com"
              role: "admin"
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  message:
                    type: string
                    example: "User updated successfully"

        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '403':
          description: Forbidden - insufficient permissions or user not in your organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

    delete:
      summary: Delete user
      description: |
        Delete a user from the organization.

        Users can only delete users from their own organization.
        Requires admin-level permissions or higher.
        Users cannot delete themselves or the organization owner.
      operationId: deleteUser
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "User deleted successfully"

        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '403':
          description: Forbidden - cannot delete yourself, owner, or insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

tags:
  - name: Users
    description: |
      User management endpoints for multi-tenant organizations.

      All operations are automatically scoped to the authenticated user's organization.
      Role-based permissions control what operations are allowed.