openapi: 3.0.3
info:
  title: OPBX Cloudonix Webhooks API
  description: |
    Webhook endpoints for receiving real-time events from Cloudonix CPaaS.
    These endpoints handle call events, status updates, CDR data, and session tracking.
  version: 1.0.0
  contact:
    name: OPBX Development Team

servers:
  - url: http://localhost
    description: Local development server
  - url: https://your-domain.com
    description: Production server

components:
  schemas:
    WebhookResponse:
      type: object
      properties:
        message:
          type: string
          description: Success message
          example: "Event processed successfully"

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
        message:
          type: string
          description: Detailed error message
        details:
          type: object
          description: Additional error details

    CallInitiatedPayload:
      type: object
      description: Payload for call-initiated webhook events
      properties:
        CallSid:
          type: string
          description: Unique call identifier
          example: "CA123456789"
        From:
          type: string
          description: Caller's phone number
          example: "+1234567890"
        To:
          type: string
          description: Dialed number
          example: "+0987654321"
        Direction:
          type: string
          enum: [inbound, outbound]
          description: Call direction
        CallStatus:
          type: string
          description: Current call status
          example: "ringing"
        ApiVersion:
          type: string
          description: API version
          example: "2010-04-01"
        Called:
          type: string
          description: The phone number that was called
        Caller:
          type: string
          description: The phone number that made the call
        FromCity:
          type: string
          description: City of the caller (if available)
        FromState:
          type: string
          description: State of the caller (if available)
        FromZip:
          type: string
          description: ZIP code of the caller (if available)
        FromCountry:
          type: string
          description: Country of the caller (if available)
        ToCity:
          type: string
          description: City of the recipient (if available)
        ToState:
          type: string
          description: State of the recipient (if available)
        ToZip:
          type: string
          description: ZIP code of the recipient (if available)
        ToCountry:
          type: string
          description: Country of the recipient (if available)

    CallStatusPayload:
      type: object
      description: Payload for call status update webhook events
      properties:
        CallSid:
          type: string
          description: Unique call identifier
          example: "CA123456789"
        CallStatus:
          type: string
          enum: [queued, ringing, in-progress, completed, busy, failed, no-answer, canceled]
          description: Current call status
          example: "completed"
        CallDuration:
          type: string
          description: Call duration in seconds
          example: "45"
        From:
          type: string
          description: Caller's phone number
        To:
          type: string
          description: Recipient's phone number
        Direction:
          type: string
          enum: [inbound, outbound]
          description: Call direction

    CdrPayload:
      type: object
      description: Payload for Call Detail Record webhook events
      properties:
        to:
          type: string
          description: Destination number
          example: "+0987654321"
        from:
          type: string
          description: Source number
          example: "+1234567890"
        owner:
          type: object
          properties:
            domain:
              type: object
              properties:
                name:
                  type: string
                  example: "yourdomain.cloudonix.net"
                uuid:
                  type: string
                  example: "domain-uuid"
            tenant:
              type: object
              properties:
                name:
                  type: string
                  example: "tenant-name"
                uuid:
                  type: string
                  example: "tenant-uuid"
        route:
          type: object
          nullable: true
          description: Routing information
        domain:
          type: string
          description: Domain name
        billsec:
          type: integer
          description: Billed duration in seconds
          example: 45
        call_id:
          type: string
          description: Unique call identifier
          example: "call-12345"
        session:
          type: object
          properties:
            id:
              type: integer
              description: Session ID
              example: 21956157
            token:
              type: string
              description: Session token
            domain:
              type: string
              nullable: true
            status:
              type: string
              description: Final session status
              example: "ANSWER"
            profile:
              type: object
              description: Session profile with QoS and metadata
            callerId:
              type: string
              description: Caller ID
            domainId:
              type: integer
              description: Domain ID
            timeLimit:
              type: integer
              description: Time limit
            vappServer:
              type: string
              description: Voice application server
            callEndTime:
              type: integer
              description: Call end timestamp (Unix milliseconds)
            destination:
              type: string
              description: Destination number
            callStartTime:
              type: integer
              description: Call start timestamp (Unix milliseconds)
            callAnswerTime:
              type: integer
              description: Call answer timestamp (Unix milliseconds)
        duration:
          type: integer
          description: Total call duration in seconds
        timestamp:
          type: integer
          description: Event timestamp
        _organization_id:
          type: integer
          description: Organization ID (added by webhook processing)

    SessionUpdatePayload:
      type: object
      description: Payload for session update webhook events
      properties:
        id:
          type: integer
          description: Session ID
          example: 21956157
        eventId:
          type: string
          description: Unique event identifier
          example: "evt-12345"
        domainId:
          type: integer
          description: Domain ID
          example: 1780
        domain:
          type: string
          description: Domain name
          example: "yourdomain.cloudonix.net"
        subscriberId:
          type: integer
          nullable: true
          description: Subscriber ID
        callerId:
          type: string
          description: Caller ID
          example: "+1234567890"
        destination:
          type: string
          description: Destination number
          example: "+0987654321"
        direction:
          type: string
          enum: [incoming, outgoing]
          description: Call direction
        status:
          type: string
          enum: [processing, ringing, connected, answer, cancelled]
          description: Session status
          example: "ringing"
        createdAt:
          type: string
          description: Session creation timestamp
          example: "2025-12-30T10:09:39.000000Z"
        modifiedAt:
          type: string
          description: Session modification timestamp
          example: "2025-12-30T10:09:40.000000Z"
        callStartTime:
          type: integer
          nullable: true
          description: Call start time (Unix timestamp)
        startTime:
          type: string
          nullable: true
          description: Call start time (ISO format)
        callAnswerTime:
          type: integer
          nullable: true
          description: Call answer time (Unix timestamp)
        answerTime:
          type: string
          nullable: true
          description: Call answer time (ISO format)
        timeLimit:
          type: integer
          nullable: true
          description: Time limit in seconds
        vappServer:
          type: string
          nullable: true
          description: Voice application server
        action:
          type: string
          description: Event action
          example: "updated"
        reason:
          type: string
          nullable: true
          description: Event reason
        callIds:
          type: array
          items:
            type: string
          description: Associated call IDs
          example: ["call-12345"]
        profile:
          type: object
          description: Additional session profile data

paths:
  /webhooks/cloudonix/call-initiated:
    post:
      summary: Call Initiated Webhook
      description: |
        Receives notification when a new call is initiated in Cloudonix.

        This webhook is triggered when a call starts and provides initial call details.
        The system processes this to determine routing logic and create initial call records.
      operationId: callInitiatedWebhook
      tags:
        - Call Events
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/CallInitiatedPayload'
            example:
              CallSid: "CA123456789"
              From: "+1234567890"
              To: "+0987654321"
              Direction: "inbound"
              CallStatus: "ringing"
      responses:
        '200':
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'

        '400':
          description: Invalid webhook payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /webhooks/cloudonix/call-status:
    post:
      summary: Call Status Update Webhook
      description: |
        Receives status updates for ongoing calls.

        This webhook is triggered when call status changes (ringing, answered, completed, etc.).
        Used to update call records and trigger business logic based on status changes.
      operationId: callStatusWebhook
      tags:
        - Call Events
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/CallStatusPayload'
            example:
              CallSid: "CA123456789"
              CallStatus: "completed"
              CallDuration: "45"
              From: "+1234567890"
              To: "+0987654321"
              Direction: "inbound"
      responses:
        '200':
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'

        '400':
          description: Invalid webhook payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /webhooks/cloudonix/cdr:
    post:
      summary: Call Detail Record Webhook
      description: |
        Receives final call detail records when calls complete.

        This webhook contains comprehensive call data including QoS metrics,
        duration, costs, and complete call metadata. Used for billing,
        analytics, and detailed call logging.
      operationId: cdrWebhook
      tags:
        - Call Events
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CdrPayload'
            example:
              to: "+0987654321"
              from: "+1234567890"
              domain: "yourdomain.cloudonix.net"
              billsec: 45
              call_id: "call-12345"
              session:
                id: 21956157
                status: "ANSWER"
                callerId: "+1234567890"
                destination: "+0987654321"
                callStartTime: 1640998800000
                callAnswerTime: 1640998805000
                callEndTime: 1640998845000
              duration: 50
              timestamp: 1640998845
              _organization_id: 1
      responses:
        '200':
          description: CDR processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'

        '400':
          description: Invalid CDR payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /webhooks/cloudonix/session-update:
    post:
      summary: Session Update Webhook
      description: |
        Receives real-time session status updates during active calls.

        This webhook provides granular updates about call session state changes.
        Critical for live call monitoring and real-time dashboards.
        High-volume endpoint that requires optimized processing.
      operationId: sessionUpdateWebhook
      tags:
        - Session Events
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionUpdatePayload'
            example:
              id: 21956157
              eventId: "evt-12345"
              domainId: 1780
              domain: "yourdomain.cloudonix.net"
              subscriberId: 248846
              callerId: "+1234567890"
              destination: "+2000"
              direction: "outgoing"
              status: "ringing"
              createdAt: "2025-12-30T10:09:39.000000Z"
              modifiedAt: "2025-12-30T10:09:40.000000Z"
              action: "updated"
              reason: "api"
              callIds: ["HKyZ31CbMhwnIZV2ScJJMQ.."]
              profile: {}
      responses:
        '200':
          description: Session update processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'

        '400':
          description: Invalid session update payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

tags:
  - name: Call Events
    description: |
      Webhook endpoints for processing Cloudonix call lifecycle events.

      These endpoints receive real-time notifications from Cloudonix CPaaS
      and update the PBX system state accordingly. All endpoints include
      signature verification and idempotency protection.

  - name: Session Events
    description: |
      High-frequency session update webhooks for real-time call monitoring.

      These events provide granular visibility into call session state changes
      and are optimized for high-throughput processing.