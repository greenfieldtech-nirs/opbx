openapi: 3.0.3
info:
  title: OPBX Session Updates API
  description: |
    API for retrieving and monitoring active call sessions in real-time.
    Provides information about currently active calls, their status, and detailed session history.
  version: 1.0.0
  contact:
    name: OPBX Development Team

servers:
  - url: http://localhost/api/v1
    description: Local development server
  - url: https://api.opbx.cloudonix.com/api/v1
    description: Production server

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Laravel Sanctum Bearer token authentication

  schemas:
    Error:
      type: object
      properties:
        message:
          type: string
          description: Error message
        errors:
          type: object
          description: Detailed validation errors

    ActiveCall:
      type: object
      properties:
        session_id:
          type: integer
          description: Unique Cloudonix session identifier
          example: 21956157
        session_token:
          type: string
          description: Cloudonix session token
          example: "dded137e38f54ee88b8a7f17b33b4da9"
        caller_id:
          type: string
          description: Normalized caller phone number
          example: "+1004"
        destination:
          type: string
          description: Normalized destination phone number
          example: "+2000"
        direction:
          type: string
          enum: [incoming, outgoing]
          description: Call direction
          example: "outgoing"
        status:
          type: string
          enum: [processing, ringing, connected]
          description: Current call status
          example: "connected"
        session_created_at:
          type: string
          format: date-time
          description: When session was created
          example: "2025-12-30T10:09:39.000000Z"
        last_updated_at:
          type: string
          format: date-time
          description: When last status update occurred
          example: "2025-12-30T10:09:50.000000Z"
        duration_seconds:
          type: integer
          description: Seconds since session creation
          example: 11
        formatted_duration:
          type: string
          description: Human-readable duration
          example: "11s"
        domain:
          type: string
          description: Cloudonix domain
          example: "dograh-ejm4ke.cloudonix.net"
        subscriber_id:
          type: integer
          description: Cloudonix subscriber identifier
          example: 248846
        call_ids:
          type: array
          items:
            type: string
          description: Cloudonix call identifiers
          example: ["HKyZ31CbMhwnIZV2ScJJMQ.."]
        has_qos_data:
          type: boolean
          description: Whether QoS metrics are available
          example: true

    ActiveCallsMeta:
      type: object
      properties:
        total_active_calls:
          type: integer
          description: Total number of active calls
          example: 3
        by_status:
          type: object
          properties:
            processing:
              type: integer
              example: 1
            ringing:
              type: integer
              example: 1
            connected:
              type: integer
              example: 1
        by_direction:
          type: object
          properties:
            incoming:
              type: integer
              example: 0
            outgoing:
              type: integer
              example: 3
        last_updated:
          type: string
          format: date-time
          description: When data was last refreshed
          example: "2025-12-30T10:10:00.000000Z"
        cache_expires_in:
          type: integer
          description: Seconds until cache expires
          example: 5

    ActiveCallsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/ActiveCall'
        meta:
          $ref: '#/components/schemas/ActiveCallsMeta'

    SessionEvent:
      type: object
      properties:
        id:
          type: integer
          description: Session update record ID
          example: 10
        event_id:
          type: string
          description: Unique event identifier
          example: "cc258852-7371-4513-94cb-baae7edbca89"
        status:
          type: string
          enum: [processing, ringing, connected, answer, cancelled]
          description: Call status at this event
          example: "processing"
        action:
          type: string
          description: Event action type
          example: "updated"
        reason:
          type: string
          description: Event reason
          example: "api"
        created_at:
          type: string
          format: date-time
          description: When this event occurred
          example: "2025-12-30T10:09:40.000000Z"

    SessionDetails:
      type: object
      properties:
        session_id:
          type: integer
          description: Session identifier
          example: 21956157
        events:
          type: array
          items:
            $ref: '#/components/schemas/SessionEvent'

    SessionStats:
      type: object
      properties:
        total_active:
          type: integer
          description: Total active calls
          example: 5
        by_status:
          type: object
          properties:
            processing:
              type: integer
              example: 2
            ringing:
              type: integer
              example: 2
            connected:
              type: integer
              example: 1
        by_direction:
          type: object
          properties:
            incoming:
              type: integer
              example: 1
            outgoing:
              type: integer
              example: 4
        average_duration:
          type: integer
          description: Average call duration in seconds
          example: 45
        longest_call:
          type: integer
          description: Longest active call in seconds
          example: 180

  parameters:
    SessionId:
      name: session_id
      in: path
      required: true
      schema:
        type: integer
      description: Unique session identifier
      example: 21956157

    StatusFilter:
      name: status
      in: query
      required: false
      schema:
        type: string
        enum: [processing, ringing, connected]
      description: Filter calls by status
      example: "ringing"

    DirectionFilter:
      name: direction
      in: query
      required: false
      schema:
        type: string
        enum: [incoming, outgoing]
      description: Filter calls by direction
      example: "outgoing"

    Limit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 100
      description: Maximum number of calls to return
      example: 50

paths:
  /session-updates/active:
    get:
      summary: Get active calls
      description: |
        Retrieve real-time information about active calls currently in progress.

        Active calls are defined as calls with status: processing, ringing, or connected.
        Only the latest status update for each unique session_id is considered.
      operationId: getActiveCalls
      tags:
        - Session Updates
      parameters:
        - $ref: '#/components/parameters/StatusFilter'
        - $ref: '#/components/parameters/DirectionFilter'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: Successful response with active calls data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActiveCallsResponse'
              example:
                data:
                  - session_id: 21956157
                    session_token: "dded137e38f54ee88b8a7f17b33b4da9"
                    caller_id: "+1004"
                    destination: "+2000"
                    direction: "outgoing"
                    status: "connected"
                    session_created_at: "2025-12-30T10:09:39.000000Z"
                    last_updated_at: "2025-12-30T10:09:50.000000Z"
                    duration_seconds: 11
                    formatted_duration: "11s"
                    domain: "dograh-ejm4ke.cloudonix.net"
                    subscriber_id: 248846
                    call_ids: ["HKyZ31CbMhwnIZV2ScJJMQ.."]
                    has_qos_data: true
                meta:
                  total_active_calls: 1
                  by_status:
                    processing: 0
                    ringing: 0
                    connected: 1
                  by_direction:
                    incoming: 0
                    outgoing: 1
                  last_updated: "2025-12-30T10:10:00.000000Z"
                  cache_expires_in: 5

        '401':
          description: Unauthorized - invalid or missing authentication token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Unauthenticated."

        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "This action is unauthorized."

        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "API rate limit exceeded."

        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Unable to retrieve active calls"

  /session-updates/{session_id}:
    get:
      summary: Get session details
      description: |
        Retrieve complete event history for a specific session.

        Returns all session update events for the given session_id,
        ordered by creation time (oldest first).
      operationId: getSessionDetails
      tags:
        - Session Updates
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Successful response with session event history
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/SessionDetails'
              example:
                data:
                  session_id: 21956157
                  events:
                    - id: 10
                      event_id: "cc258852-7371-4513-94cb-baae7edbca89"
                      status: "processing"
                      action: "updated"
                      reason: "api"
                      created_at: "2025-12-30T10:09:40.000000Z"
                    - id: 11
                      event_id: "8a3cc83b-09b9-4589-998f-132571b02146"
                      status: "ringing"
                      action: "updated"
                      reason: "api"
                      created_at: "2025-12-30T10:09:40.000000Z"

        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '403':
          description: Forbidden - session not accessible by this organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Session not found or access denied."

        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Session not found."

        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /session-updates/active/stats:
    get:
      summary: Get active calls statistics
      description: |
        Retrieve aggregated statistics about active calls without detailed call data.

        Useful for dashboard widgets and monitoring systems that need
        high-level metrics without individual call details.
      operationId: getActiveCallsStats
      tags:
        - Session Updates
      responses:
        '200':
          description: Successful response with active calls statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/SessionStats'
              example:
                data:
                  total_active: 5
                  by_status:
                    processing: 2
                    ringing: 2
                    connected: 1
                  by_direction:
                    incoming: 1
                    outgoing: 4
                  average_duration: 45
                  longest_call: 180

        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

tags:
  - name: Session Updates
    description: |
      APIs for monitoring and retrieving real-time call session information.

      Active calls are automatically updated every 5 seconds in the UI.
      All endpoints require authentication and are scoped to the user's organization.